<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Suika Game - Pro Custom</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; background: #1a1a1a; overflow: hidden; font-family: 'Arial Rounded MT Bold', sans-serif; }
        #fileInput { display: none; }
        .custom-ui {
            position: absolute; top: -1000px; left: 50%; transform: translateX(-50%);
            z-index: 5000; background: #ffffff; padding: 25px; border-radius: 20px;
            width: 320px; text-align: center; box-shadow: 0 15px 50px rgba(0,0,0,0.6);
            transition: top 0.5s ease; border: 4px solid #5d4037;
        }
        .ui-open { top: 50px !important; }
        .status-msg { margin: 10px 0; font-weight: bold; font-size: 14px; }
        input[type="text"] { width: 90%; padding: 12px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 8px; }
        input[type="range"] { width: 100%; margin: 15px 0; accent-color: #ba68c8; }
        button { cursor: pointer; border-radius: 8px; font-weight: bold; padding: 12px; width: 100%; border: none; margin-bottom: 8px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #ba68c8; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="editor-ui" class="custom-ui">
        <h3 id="edit-title" style="margin: 0 0 15px 0; color: #5d4037;">Editor</h3>
        
        <div id="volume-control" style="display:none; margin-bottom: 20px;">
            <label style="font-size: 14px; color: #555;">Volumen Música: <span id="volVal">50%</span></label>
            <input type="range" id="volSlider" min="0" max="100" value="50" oninput="updateVol(this.value)">
        </div>

        <input type="text" id="urlInput" placeholder="Enlace directo (.mp3, .png, etc)...">
        <button onclick="applyURL()" style="background:#4caf50; color:white;">APLICAR ENLACE</button>
        <button onclick="document.getElementById('fileInput').click()" style="background:#5c6bc0; color:white;">IMPORTAR ARCHIVO</button>
        <button onclick="resetAsset()" style="background:#9e9e9e; color:white;">RESTABLECER</button>
        
        <div id="loadingArea" style="display:none; margin-top: 15px;">
            <div class="loader"></div>
            <span id="statusMsg" class="status-msg">Procesando...</span>
        </div>

        <button onclick="closeUI()" style="background:#f44336; color:white; margin-top:15px;">CERRAR</button>
    </div>
    <input type="file" id="fileInput" accept="image/*,audio/*">

<script>
const FRUTAS = [
    { nombre: 'Cereza', r: 15, col: 0xff3333, pts: 2, skin: null },
    { nombre: 'Fresa', r: 25, col: 0xff66aa, pts: 4, skin: null },
    { nombre: 'Uva', r: 35, col: 0x9933ff, pts: 8, skin: null },
    { nombre: 'Naranja', r: 45, col: 0xff9900, pts: 16, skin: null },
    { nombre: 'Caqui', r: 55, col: 0xffcc33, pts: 32, skin: null },
    { nombre: 'Manzana', r: 70, col: 0xff0000, pts: 64, skin: null },
    { nombre: 'Pera', r: 85, col: 0xccff33, pts: 128, skin: null },
    { nombre: 'Melocotón', r: 100, col: 0xffccaa, pts: 256, skin: null },
    { nombre: 'Piña', r: 120, col: 0xffff33, pts: 512, skin: null },
    { nombre: 'Melón', r: 140, col: 0x99ff66, pts: 1024, skin: null },
    { nombre: 'Sandía', r: 160, col: 0x00aa00, pts: 2048, skin: null }
];

let globalConfig = { vol: 0.5 };
let assetsCustom = { fondo: null, musica: null, pop: null };
let currentEdit = { tipo: '', idx: -1 };

function openUI(tipo, idx = -1, titulo = "Editor") {
    currentEdit = { tipo, idx };
    document.getElementById('edit-title').innerText = titulo;
    document.getElementById('editor-ui').classList.add('ui-open');
    document.getElementById('loadingArea').style.display = 'none';
    document.getElementById('volume-control').style.display = (tipo === 'musica') ? 'block' : 'none';
}

function closeUI() { document.getElementById('editor-ui').classList.remove('ui-open'); }

function updateVol(val) {
    globalConfig.vol = val / 100;
    document.getElementById('volVal').innerText = val + "%";
    const scene = window.gameInstance.scene.getScene('EscenaJuego');
    if(scene && scene.bgm) scene.bgm.setVolume(globalConfig.vol);
}

function resetAsset() {
    if(currentEdit.tipo === 'fruta') FRUTAS[currentEdit.idx].skin = null;
    else if(currentEdit.tipo === 'fondo') assetsCustom.fondo = null;
    else if(currentEdit.tipo === 'musica') assetsCustom.musica = null;
    else if(currentEdit.tipo === 'pop') assetsCustom.pop = null;
    alert("Restablecido");
    closeUI();
}

function applyURL() {
    const url = document.getElementById('urlInput').value;
    if(url) processData(url);
}

document.getElementById('fileInput').onchange = (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => processData(ev.target.result);
    reader.readAsDataURL(file);
};

function processData(data) {
    const scene = window.gameInstance.scene.getAt(0);
    const key = `cust_${Date.now()}`;
    const status = document.getElementById('statusMsg');
    document.getElementById('loadingArea').style.display = 'block';
    status.innerText = "Cargando...";

    if (currentEdit.tipo === 'fruta' || currentEdit.tipo === 'fondo') scene.load.image(key, data);
    else scene.load.audio(key, data);

    scene.load.once('complete', () => {
        if (currentEdit.tipo === 'fruta') FRUTAS[currentEdit.idx].skin = key;
        else if (currentEdit.tipo === 'fondo') assetsCustom.fondo = key;
        else if (currentEdit.tipo === 'musica') assetsCustom.musica = key;
        else if (currentEdit.tipo === 'pop') assetsCustom.pop = key;
        status.innerText = "¡Hecho!";
        setTimeout(closeUI, 800);
    });
    scene.load.once('loaderror', () => { status.innerText = "Error en archivo"; });
    scene.load.start();
}

// --- ESCENAS ---
class EscenaMenu extends Phaser.Scene {
    constructor() { super('EscenaMenu'); }
    create() {
        window.gameInstance = this.game;
        const { width: w, height: h } = this.scale;
        this.add.rectangle(w/2, h/2, w, h, 0xfffae5);
        this.add.text(w/2, 120, 'SUIKA CUSTOM', { fontSize: '50px', color: '#5d4037', fontStyle: 'bold' }).setOrigin(0.5);
        this.btn(w/2, 280, 'JUGAR', 0x66bb6a, () => this.scene.start('EscenaJuego'));
        this.btn(w/2, 360, 'SKINS FRUTAS', 0xff8a65, () => this.scene.launch('EscenaEditorFrutas'));
        this.btn(w/2, 440, 'PERSONALIZAR FONDO', 0x4fc3f7, () => openUI('fondo', -1, 'Fondo'));
        this.btn(w/2, 520, 'MÚSICA / SONIDOS', 0xba68c8, () => openUI('musica', -1, 'Audio'));
    }
    btn(x, y, txt, col, act) {
        const b = this.add.rectangle(x, y, 320, 60, col).setInteractive({useHandCursor:true});
        this.add.text(x, y, txt, { fontSize: '20px', color: '#fff' }).setOrigin(0.5);
        b.on('pointerdown', act);
    }
}

class EscenaEditorFrutas extends Phaser.Scene {
    constructor() { super('EscenaEditorFrutas'); }
    create() {
        const { width: w, height: h } = this.scale;
        this.add.rectangle(w/2, h/2, w, h, 0x000000, 0.85);
        let idx = 0;
        const nombre = this.add.text(w/2, h/2 - 50, FRUTAS[idx].nombre, { fontSize: '45px', color: '#fff' }).setOrigin(0.5);
        this.add.text(60, h/2 - 50, '❮', { fontSize: '70px' }).setInteractive().on('pointerdown', () => { idx=(idx-1+FRUTAS.length)%FRUTAS.length; nombre.setText(FRUTAS[idx].nombre); });
        this.add.text(w-60, h/2 - 50, '❯', { fontSize: '70px' }).setInteractive().on('pointerdown', () => { idx=(idx+1)%FRUTAS.length; nombre.setText(FRUTAS[idx].nombre); });
        const bImp = this.add.rectangle(w/2, h/2 + 80, 240, 60, 0xff8a65).setInteractive();
        this.add.text(w/2, h/2 + 80, 'CARGAR SKIN', { fontSize: '22px' }).setOrigin(0.5);
        bImp.on('pointerdown', () => openUI('fruta', idx, `Skin: ${FRUTAS[idx].nombre}`));
        this.add.text(w/2, h-80, 'VOLVER', { fontSize: '25px', color: '#ff4444' }).setInteractive().on('pointerdown', () => this.scene.stop());
    }
}

class EscenaJuego extends Phaser.Scene {
    constructor() { super('EscenaJuego'); }
    create() {
        const { width: w, height: h } = this.scale;
        this.puntos = 0; this.gameOver = false; this.frutasActivas = [];
        if(assetsCustom.fondo) this.add.image(w/2, h/2, assetsCustom.fondo).setDisplaySize(w, h);
        else this.add.rectangle(w/2, h/2, w, h, 0xfffae5);

        const p = { isStatic: true, friction: 0.1 };
        this.matter.add.rectangle(w/2, h+100, w, 220, p);
        this.matter.add.rectangle(-100, h/2, 220, h*2, p);
        this.matter.add.rectangle(w+100, h/2, 220, h*2, p);
        this.add.rectangle(w/2, h-10, w, 20, 0x8d6e63).setDepth(5);
        this.add.rectangle(10, h/2, 20, h, 0x8d6e63).setDepth(5);
        this.add.rectangle(w-10, h/2, 20, h, 0x8d6e63).setDepth(5);

        this.lineaRoja = this.add.rectangle(w/2, 190, w-40, 4, 0xff0000, 0.6).setDepth(10);
        this.txtPuntos = this.add.text(w/2, 90, '0', { fontSize: '100px', color: '#5d4037', alpha: 0.2 }).setOrigin(0.5);
        
        if(assetsCustom.musica && this.cache.audio.exists(assetsCustom.musica)) {
            this.bgm = this.sound.add(assetsCustom.musica, { loop: true, volume: globalConfig.vol });
            this.bgm.play();
        }

        this.proximoIndice = Math.floor(Math.random() * 4);
        this.prepararNuevaFruta();

        this.input.on('pointermove', (p) => { if (this.frutaGuia && !this.gameOver) {
            const r = FRUTAS[this.frutaGuia.tipoIndex].r;
            this.frutaGuia.x = Phaser.Math.Clamp(p.x, 30+r, w-30-r);
        }});
        this.input.on('pointerdown', () => { if (this.puedeSoltar && !this.gameOver) this.soltarFruta(); });
        this.matter.world.on('collisionstart', (ev) => { ev.pairs.forEach(pair => {
            const { bodyA, bodyB } = pair;
            if (bodyA.gameObject?.tipoIndex !== undefined && bodyB.gameObject?.tipoIndex !== undefined) this.fusion(bodyA.gameObject, bodyB.gameObject);
        });});
    }

    prepararNuevaFruta() {
        const idx = this.proximoIndice;
        this.proximoIndice = Math.floor(Math.random() * 4);
        this.frutaGuia = this.crearVisual(this.input.activePointer.x, 110, idx);
        this.puedeSoltar = true;
    }

    crearVisual(x, y, idx) {
        const f = FRUTAS[idx];
        const container = this.add.container(x, y);
        if (f.skin) container.add(this.add.image(0,0, f.skin).setDisplaySize(f.r*2, f.r*2));
        else container.add(this.add.circle(0, 0, f.r, f.col).setStrokeStyle(2, 0x444444));
        container.tipoIndex = idx;
        return container;
    }

    soltarFruta() {
        this.puedeSoltar = false;
        const idx = this.frutaGuia.tipoIndex;
        const xPos = this.frutaGuia.x;
        this.frutaGuia.destroy();
        this.spawnFisica(xPos, 110, idx);
        this.time.delayedCall(600, () => { if(!this.gameOver) this.prepararNuevaFruta(); });
    }

    spawnFisica(x, y, idx) {
        const f = FRUTAS[idx];
        const body = this.matter.add.circle(x, y, f.r, { restitution: 0.3, friction: 0.1 });
        const visual = this.crearVisual(x, y, idx);
        body.gameObject = visual; visual.bodyRef = body; visual.soltada = true;
        this.frutasActivas.push(visual);
    }

    fusion(a, b) {
        if (!a.active || !b.active || a.tipoIndex !== b.tipoIndex || a.isMerging || b.isMerging || a.tipoIndex >= FRUTAS.length-1) return;
        a.isMerging = b.isMerging = true;
        if(assetsCustom.pop && this.cache.audio.exists(assetsCustom.pop)) this.sound.play(assetsCustom.pop);
        const nIdx = a.tipoIndex + 1;
        this.puntos += FRUTAS[nIdx].pts;
        this.txtPuntos.setText(this.puntos);
        const nx = (a.x + b.x)/2; const ny = (a.y + b.y)/2;
        this.matter.world.remove(a.bodyRef); this.matter.world.remove(b.bodyRef);
        this.frutasActivas = this.frutasActivas.filter(f => f !== a && f !== b);
        a.destroy(); b.destroy();
        this.time.delayedCall(1, () => this.spawnFisica(nx, ny, nIdx));
    }

    update() {
        if (this.gameOver) return;
        let p = false;
        this.frutasActivas.forEach(f => { if (f.active && f.bodyRef) {
            f.x = f.bodyRef.position.x; f.y = f.bodyRef.position.y; f.rotation = f.bodyRef.angle;
            if (f.soltada && f.y < 195) { p = true; if (!f.timer) f.timer = Date.now(); if (Date.now()-f.timer > 3000) this.finalizar(); }
            else f.timer = null;
        }});
        this.lineaRoja.alpha = p ? Math.abs(Math.sin(this.time.now / 150)) : 0.6;
    }

    finalizar() {
        this.gameOver = true; this.matter.world.pause(); this.sound.stopAll();
        const { width: w, height: h } = this.scale;
        const panel = this.add.container(w/2, h/2).setDepth(10000);
        panel.add(this.add.rectangle(0, 0, 350, 400, 0x000000, 0.9).setStrokeStyle(4, 0xffffff));
        panel.add(this.add.text(0, -120, 'GAME OVER', { fontSize: '45px', color: '#ff4444' }).setOrigin(0.5));
        const br = this.add.rectangle(0, 60, 220, 60, 0x66bb6a).setInteractive();
        panel.add([br, this.add.text(0, 60, 'REINTENTAR').setOrigin(0.5)]);
        br.on('pointerdown', () => this.scene.restart());
        const bm = this.add.rectangle(0, 140, 220, 60, 0x8d6e63).setInteractive();
        panel.add([bm, this.add.text(0, 140, 'MENÚ').setOrigin(0.5)]);
        bm.on('pointerdown', () => this.scene.start('EscenaMenu'));
    }
}

const config = {
    type: Phaser.AUTO,
    scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH, width: 450, height: 800 },
    physics: { default: 'matter', matter: { gravity: { y: 2.5 } } },
    scene: [EscenaMenu, EscenaEditorFrutas, EscenaJuego]
};
new Phaser.Game(config);
</script>
</body>
          </html>
