<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Suika Game Ultimate</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; background: #1a1a1a; overflow: hidden; font-family: 'Arial Rounded MT Bold', sans-serif; }
        #fileInput { display: none; }
        .custom-ui {
            position: absolute; top: -1000px; left: 50%; transform: translateX(-50%);
            z-index: 5000; background: rgba(255, 255, 255, 0.98); padding: 30px; 
            border-radius: 30px; width: 340px; text-align: center; 
            box-shadow: 0 25px 80px rgba(0,0,0,0.9);
            transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            border: 6px solid #5d4037; backdrop-filter: blur(10px);
        }
        .ui-open { top: 40px !important; }
        h3 { margin: 0 0 20px 0; color: #5d4037; font-size: 24px; text-transform: uppercase; }
        input[type="text"] { width: 90%; padding: 15px; margin-bottom: 15px; border: 3px solid #eee; border-radius: 12px; outline: none; }
        .vol-container { 
            background: #fff9f0; padding: 15px; border-radius: 15px; 
            margin-bottom: 10px; text-align: left; border: 2px solid #eee1d0;
        }
        .vol-container label { display: block; margin-bottom: 5px; color: #5d4037; font-weight: bold; font-size: 11px; }
        input[type="range"] { width: 100%; accent-color: #ff8a65; cursor: pointer; }
        button { 
            cursor: pointer; border-radius: 15px; font-weight: bold; 
            padding: 16px; width: 100%; border: none; margin-bottom: 10px; 
            font-size: 16px; color: white; transition: 0.2s;
        }
        button:active { transform: scale(0.95); }
        .status-msg { font-size: 14px; font-weight: bold; display: block; margin: 10px 0; color: #ff8a65; }
    </style>
</head>
<body>
    <div id="editor-ui" class="custom-ui">
        <h3 id="edit-title">CONFIGURACIÓN</h3>
        <div id="audio-settings" style="display:none;">
            <div class="vol-container">
                <label id="labelVol">VOLUMEN: <span id="vValText">50%</span></label>
                <input type="range" id="volRange" min="0" max="100" value="50" oninput="updateVolUI()">
            </div>
        </div>
        <input type="text" id="urlInput" placeholder="Enlace o nombre...">
        <button id="mainBtn" onclick="handleApply()" style="background: #4caf50; box-shadow: 0 5px 0 #2e7d32;">APLICAR</button>
        <button id="fileBtn" onclick="document.getElementById('fileInput').click()" style="background: #5c6bc0; box-shadow: 0 5px 0 #3949ab;">SUBIR ARCHIVO</button>
        <span id="statusMsg" class="status-msg"></span>
        <button onclick="closeUI()" style="background: #e57373; box-shadow: 0 5px 0 #c62828; margin-top: 10px;">CERRAR</button>
    </div>
    <input type="file" id="fileInput" accept="image/*,audio/*">

<script>
const FRUTAS = [
    { nombre: 'Cereza', r: 15, col: 0xff3333, pts: 2, skin: null },
    { nombre: 'Fresa', r: 25, col: 0xff66aa, pts: 4, skin: null },
    { nombre: 'Uva', r: 35, col: 0x9933ff, pts: 8, skin: null },
    { nombre: 'Naranja', r: 45, col: 0xff9900, pts: 16, skin: null },
    { nombre: 'Caqui', r: 55, col: 0xffcc33, pts: 32, skin: null },
    { nombre: 'Manzana', r: 70, col: 0xff0000, pts: 64, skin: null },
    { nombre: 'Pera', r: 85, col: 0xccff33, pts: 128, skin: null },
    { nombre: 'Melocotón', r: 100, col: 0xffccaa, pts: 256, skin: null },
    { nombre: 'Piña', r: 120, col: 0xffff33, pts: 512, skin: null },
    { nombre: 'Melón', r: 140, col: 0x99ff66, pts: 1024, skin: null },
    { nombre: 'Sandía', r: 160, col: 0x00aa00, pts: 2048, skin: null }
];

let globalConfig = { 
    fondo: null, 
    musicaKey: 'musica_default', 
    popKey: 'pop_default', 
    volM: 0.5, 
    volP: 0.8, 
    nombreJugador: "Jugador" 
};

let editState = { tipo: '', idx: -1 };
let leaderboard = JSON.parse(localStorage.getItem('suika_scores')) || [];

function openUI(tipo, idx = -1, titulo = "EDITOR") {
    editState = { tipo, idx };
    document.getElementById('edit-title').innerText = titulo;
    const isAudio = (tipo === 'musica' || tipo === 'pop');
    document.getElementById('audio-settings').style.display = isAudio ? 'block' : 'none';
    document.getElementById('urlInput').value = (tipo === 'nombre') ? globalConfig.nombreJugador : "";
    document.getElementById('urlInput').placeholder = (tipo === 'nombre') ? "Tu nombre..." : "Pega el enlace aquí...";
    document.getElementById('fileBtn').style.display = (tipo === 'nombre') ? "none" : "block";
    
    if(isAudio) {
        const val = (tipo === 'musica') ? globalConfig.volM : globalConfig.volP;
        document.getElementById('volRange').value = val * 100;
        document.getElementById('vValText').innerText = Math.round(val * 100) + "%";
        document.getElementById('labelVol').innerText = (tipo === 'musica') ? "VOLUMEN MÚSICA:" : "VOLUMEN POP:";
    }
    document.getElementById('editor-ui').classList.add('ui-open');
}

function closeUI() { document.getElementById('editor-ui').classList.remove('ui-open'); }

function updateVolUI() {
    const val = document.getElementById('volRange').value / 100;
    document.getElementById('vValText').innerText = Math.round(val * 100) + "%";
    if(editState.tipo === 'musica') {
        globalConfig.volM = val;
        const sc = window.game.scene.getScene('EscenaJuego');
        if(sc && sc.bgm) sc.bgm.setVolume(val);
    } else if(editState.tipo === 'pop') globalConfig.volP = val;
}

function handleApply() {
    const val = document.getElementById('urlInput').value;
    if(editState.tipo === 'nombre') {
        globalConfig.nombreJugador = val || "Jugador";
        closeUI();
        if(window.game.scene.isActive('EscenaMenu')) window.game.scene.getScene('EscenaMenu').scene.restart();
    } else if(val) processResource(val);
}

document.getElementById('fileInput').onchange = (e) => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = (ev) => processResource(ev.target.result);
    reader.readAsDataURL(file);
};

function processResource(source) {
    const status = document.getElementById('statusMsg');
    const sc = window.game.scene.scenes[0];
    const key = `res_${Date.now()}`;
    status.innerText = "CARGANDO...";
    if (editState.tipo === 'musica' || editState.tipo === 'pop') sc.load.audio(key, source);
    else sc.load.image(key, source);
    sc.load.once('complete', () => {
        if(editState.tipo === 'fruta') FRUTAS[editState.idx].skin = key;
        else if(editState.tipo === 'fondo') globalConfig.fondo = key;
        else if(editState.tipo === 'musica') globalConfig.musicaKey = key;
        else if(editState.tipo === 'pop') globalConfig.popKey = key;
        status.innerText = "¡LISTO!";
        setTimeout(closeUI, 800);
    });
    sc.load.start();
}

class EscenaMenu extends Phaser.Scene {
    constructor() { super('EscenaMenu'); }

    preload() {
        // RUTA CORREGIDA PARA TU CARPETA ASSETS
        this.load.audio('musica_default', 'assets/musica.mp3');
        this.load.audio('pop_default', 'assets/pop.mp3');
        this.load.image('fondo_default', 'assets/fondo.jpg');

        const { width: w, height: h } = this.scale;
        const progressBar = this.add.graphics();
        this.load.on('progress', (value) => {
            progressBar.clear();
            progressBar.fillStyle(0xff8a65, 1);
            progressBar.fillRoundedRect(w/2 - 105, h/2 - 10, 210 * value, 20, 8);
        });
        this.load.on('complete', () => {
            progressBar.destroy();
            if (this.textures.exists('fondo_default')) globalConfig.fondo = 'fondo_default';
        });
    }

    create() {
        window.game = this.game;
        const { width: w, height: h } = this.scale;
        this.add.rectangle(w/2, h/2, w, h, 0xfffae5);
        this.add.circle(w/2, h, w, 0xffe0b2, 0.4);
        
        // DESBLOQUEO DE AUDIO PARA MÓVILES
        this.input.once('pointerdown', () => {
            if (this.sound.context.state === 'suspended') {
                this.sound.context.resume();
            }
        });

        this.add.text(w/2, 80, 'SUIKA', { fontSize: '80px', color: '#5d4037', fontStyle: 'bold' }).setOrigin(0.5);
        
        const userGroup = this.add.container(w/2, 160).setInteractive(new Phaser.Geom.Rectangle(-100,-20,200,40), Phaser.Geom.Rectangle.Contains);
        userGroup.add(this.add.text(0, 0, `HOLA, ${globalConfig.nombreJugador.toUpperCase()} ✎`, { fontSize: '20px', color: '#8d6e63', fontStyle: 'bold' }).setOrigin(0.5));
        userGroup.on('pointerdown', () => openUI('nombre', -1, 'TU NOMBRE'));

        this.add.text(w/2, 220, 'TOP SCORES', { fontSize: '16px', color: '#a1887f', fontStyle: 'bold' }).setOrigin(0.5);
        leaderboard.slice(0, 3).forEach((entry, i) => {
            this.add.text(w/2, 250 + (i*22), `${i+1}. ${entry.name} - ${entry.score}`, { fontSize: '18px', color: '#5d4037' }).setOrigin(0.5);
        });

        const btn = (y, txt, col, act) => {
            const container = this.add.container(w/2, y);
            const b = this.add.rectangle(0, 0, 320, 60, col).setInteractive({useHandCursor:true});
            container.add([b, this.add.text(0, 0, txt, { fontSize: '18px', color: '#fff', fontStyle: 'bold' }).setOrigin(0.5)]);
            b.on('pointerdown', () => {
                this.tweens.add({ targets: container, scale: 0.95, duration: 80, yoyo: true });
                act();
            });
        };

        btn(420, 'JUGAR', 0x66bb6a, () => this.scene.start('EscenaJuego'));
        btn(490, 'PIELES FRUTAS', 0xff8a65, () => this.scene.launch('EscenaEditorFrutas'));
        btn(560, 'FONDO', 0x4fc3f7, () => openUI('fondo', -1, 'FONDO'));
        btn(630, 'MÚSICA', 0xba68c8, () => openUI('musica', -1, 'MÚSICA'));
        btn(700, 'EFECTO POP', 0x9575cd, () => openUI('pop', -1, 'SONIDO POP'));
    }
}

class EscenaEditorFrutas extends Phaser.Scene {
    constructor() { super('EscenaEditorFrutas'); }
    create() {
        const { width: w, height: h } = this.scale;
        this.add.rectangle(w/2, h/2, w, h, 0x000, 0.8).setInteractive();
        let idx = 0;
        const card = this.add.container(w/2, h/2);
        const bg = this.add.rectangle(0, 0, 320, 400, 0xffffff).setStrokeStyle(8, 0xff8a65);
        const nombre = this.add.text(0, -140, FRUTAS[idx].nombre, { fontSize: '35px', color: '#5d4037', fontStyle: 'bold' }).setOrigin(0.5);
        let previewContainer = this.add.container(0, -10);
        
        const update = () => {
            nombre.setText(FRUTAS[idx].nombre);
            previewContainer.removeAll(true);
            const f = FRUTAS[idx];
            if(f.skin) previewContainer.add(this.add.image(0, 0, f.skin).setDisplaySize(f.r*2.3, f.r*2.3));
            else {
                previewContainer.add(this.add.circle(0, 0, f.r, f.col).setStrokeStyle(3, 0xffffff));
                previewContainer.add(this.add.circle(-f.r/3, -f.r/3, f.r/4, 0xffffff, 0.4));
            }
        };
        update();
        card.add([bg, nombre, previewContainer, this.add.rectangle(0, 120, 220, 55, 0xff8a65).setInteractive().on('pointerdown', () => openUI('fruta', idx, FRUTAS[idx].nombre)), this.add.text(0, 120, 'CAMBIAR SKIN').setOrigin(0.5)]);
        this.add.text(50, h/2, '❮', {fontSize: '70px'}).setInteractive().on('pointerdown', () => { idx=(idx-1+FRUTAS.length)%FRUTAS.length; update(); });
        this.add.text(w-50, h/2, '❯', {fontSize: '70px'}).setInteractive().on('pointerdown', () => { idx=(idx+1)%FRUTAS.length; update(); });
        this.add.text(w/2, h-80, 'CERRAR', {fontSize: '20px', color: '#fff'}).setOrigin(0.5).setInteractive().on('pointerdown', () => this.scene.stop());
    }
}

class EscenaJuego extends Phaser.Scene {
    constructor() { super('EscenaJuego'); }
    create() {
        const { width: w, height: h } = this.scale;
        this.puntos = 0; this.gameOver = false; this.frutasActivas = [];
        
        if(globalConfig.fondo) this.add.image(w/2, h/2, globalConfig.fondo).setDisplaySize(w, h);
        else this.add.rectangle(w/2, h/2, w, h, 0xfffae5);

        const nextBox = this.add.container(w - 70, 70);
        nextBox.add(this.add.circle(0, 0, 45, 0xffffff, 0.8).setStrokeStyle(4, 0x5d4037));
        nextBox.add(this.add.text(0, -55, 'SIGUIENTE', {fontSize:'12px', color:'#5d4037', fontStyle:'bold'}).setOrigin(0.5));
        this.nextPreview = this.add.container(0, 0);
        nextBox.add(this.nextPreview);

        this.matter.world.setBounds(15, 0, w-30, h-15);
        this.add.rectangle(w/2, h-7, w, 15, 0x5d4037).setDepth(5);
        this.lineaRoja = this.add.rectangle(w/2, 190, w-30, 6, 0xff0000, 0.4).setDepth(10);
        this.txtPuntos = this.add.text(w/2, 110, '0', { fontSize: '130px', color: '#5d4037', alpha: 0.1, fontStyle: 'bold' }).setOrigin(0.5);
        
        if (this.sound.get(globalConfig.musicaKey)) {
            this.bgm = this.sound.add(globalConfig.musicaKey, { loop: true, volume: globalConfig.volM });
            this.bgm.play();
        }

        this.proximoIndice = Math.floor(Math.random() * 4);
        this.indiceEnEspera = Math.floor(Math.random() * 4);
        this.prepararSiguiente();

        this.input.on('pointermove', p => { if(this.guia && !this.gameOver) this.guia.x = Phaser.Math.Clamp(p.x, 40, w-40); });
        this.input.on('pointerdown', () => this.soltar());
        this.matter.world.on('collisionstart', (ev) => ev.pairs.forEach(p => { 
            if(p.bodyA.gameObject && p.bodyB.gameObject) this.fusion(p.bodyA.gameObject, p.bodyB.gameObject); 
        }));
    }

    updateNextPreview() {
        this.nextPreview.removeAll(true);
        const f = FRUTAS[this.indiceEnEspera];
        const scale = 35 / f.r; 
        if(f.skin) this.nextPreview.add(this.add.image(0,0, f.skin).setDisplaySize(f.r*2*scale*0.8, f.r*2*scale*0.8));
        else {
            this.nextPreview.add(this.add.circle(0, 0, f.r*scale*0.8, f.col).setStrokeStyle(2, 0x5d4037));
            this.nextPreview.add(this.add.circle(-5,-5, 5, 0xffffff, 0.3));
        }
    }

    prepararSiguiente() {
        this.guia = this.crearObjeto(this.input.activePointer.x, 110, this.proximoIndice);
        this.updateNextPreview();
        this.puedeSoltar = true;
    }

    crearObjeto(x, y, idx) {
        const f = FRUTAS[idx];
        const container = this.add.container(x, y);
        if (f.skin) container.add(this.add.image(0,0, f.skin).setDisplaySize(f.r*2.1, f.r*2.1));
        else {
            container.add(this.add.circle(0, 0, f.r, f.col).setStrokeStyle(3, 0xffffff));
            container.add(this.add.circle(f.r/4, f.r/4, f.r/1.5, 0x000000, 0.1));
            container.add(this.add.circle(-f.r/3, -f.r/3, f.r/4, 0xffffff, 0.4));
        }
        container.tipoIndex = idx;
        return container;
    }

    soltar() {
        if(!this.puedeSoltar || this.gameOver) return;
        this.puedeSoltar = false;
        const {x, tipoIndex} = this.guia;
        this.guia.destroy();
        this.crearFisica(x, 110, tipoIndex);
        
        this.proximoIndice = this.indiceEnEspera;
        this.indiceEnEspera = Math.floor(Math.random() * 4);
        this.time.delayedCall(500, () => this.prepararSiguiente());
    }

    crearFisica(x, y, idx) {
        const f = FRUTAS[idx];
        const visual = this.crearObjeto(x, y, idx);
        this.matter.add.gameObject(visual, { shape: { type: 'circle', radius: f.r }, restitution: 0.3 });
        visual.soltada = true;
        this.frutasActivas.push(visual);
    }

    fusion(a, b) {
        if (!a.active || !b.active || a.tipoIndex !== b.tipoIndex || a.isMerging || b.isMerging || a.tipoIndex >= FRUTAS.length-1) return;
        a.isMerging = b.isMerging = true;
        if (this.sound.get(globalConfig.popKey)) this.sound.play(globalConfig.popKey, { volume: globalConfig.volP });
        
        const nIdx = a.tipoIndex + 1;
        this.puntos += FRUTAS[nIdx].pts;
        this.txtPuntos.setText(this.puntos);
        const nx = (a.x + b.x)/2; const ny = (a.y + b.y)/2;
        this.frutasActivas = this.frutasActivas.filter(f => f !== a && f !== b);
        a.destroy(); b.destroy();
        this.crearFisica(nx, ny, nIdx);
    }

    update() {
        if (this.gameOver) return;
        let peligro = false;
        this.frutasActivas.forEach(f => {
            if (f.active && f.soltada) {
                if (f.y < 195) {
                    peligro = true;
                    if (!f.timer) f.timer = Date.now();
                    if (Date.now() - f.timer > 2500) this.finalizar();
                } else f.timer = null;
                f.rotation += f.body.angularVelocity;
            }
        });
        this.lineaRoja.alpha = peligro ? Math.abs(Math.sin(this.time.now / 150)) : 0.3;
    }

    finalizar() {
        this.gameOver = true; this.matter.world.pause(); this.sound.stopAll();
        const { width: w, height: h } = this.scale;
        
        leaderboard.push({name: globalConfig.nombreJugador, score: this.puntos});
        leaderboard.sort((a,b) => b.score - a.score);
        leaderboard = leaderboard.slice(0, 5);
        localStorage.setItem('suika_scores', JSON.stringify(leaderboard));

        const panel = this.add.container(w/2, h/2).setDepth(10000).setScale(0);
        panel.add(this.add.rectangle(0, 0, 350, 500, 0xffffff).setStrokeStyle(8, 0x5d4037));
        panel.add(this.add.text(0, -210, 'FIN DEL JUEGO', { fontSize: '38px', color: '#f44336', fontStyle: 'bold' }).setOrigin(0.5));
        panel.add(this.add.text(0, -150, `${this.puntos} PTS`, { fontSize: '50px', color: '#5d4037', fontStyle: 'bold' }).setOrigin(0.5));
        
        leaderboard.forEach((e, i) => {
            const isMe = (e.score === this.puntos && e.name === globalConfig.nombreJugador);
            panel.add(this.add.text(0, -60 + (i*25), `${i+1}. ${e.name.toUpperCase()} - ${e.score}`, { fontSize: '20px', color: isMe ? '#ff8a65' : '#5d4037' }).setOrigin(0.5));
        });

        const btnR = this.add.rectangle(0, 130, 240, 55, 0x66bb6a).setInteractive().on('pointerdown', () => this.scene.restart());
        panel.add([btnR, this.add.text(0, 130, 'REINTENTAR', {fontStyle:'bold'}).setOrigin(0.5)]);
        const btnM = this.add.rectangle(0, 200, 240, 55, 0x8d6e63).setInteractive().on('pointerdown', () => this.scene.start('EscenaMenu'));
        panel.add([btnM, this.add.text(0, 200, 'MENÚ', {fontStyle:'bold'}).setOrigin(0.5)]);

        this.tweens.add({ targets: panel, scale: 1, duration: 500, ease: 'Back.out' });
    }
}

const config = {
    type: Phaser.AUTO,
    scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH, width: 450, height: 800 },
    physics: { default: 'matter', matter: { gravity: { y: 2.2 } } },
    scene: [EscenaMenu, EscenaEditorFrutas, EscenaJuego]
};
new Phaser.Game(config);
</script>
</body>
</html>
